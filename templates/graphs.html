 {% extends 'layout.html' %}

{% block body %}

<button class="btn btn-primary btn-lg" type="button" onclick="newCanvas(charts)">New Graph</button>
<input type="text" id="output" hidden/>
<br>
<script>
  charts=[];
  numCanvas=0;
  function newCanvas(chartArray){
        var newDrop = document.createElement('select');
        var newCan = document.createElement('canvas');
        newDrop.class ="form-select form-select-lg mb-3";
                dev = {{Devices | safe}}
                var sel = new Option("Sensor","",false,false);
                newDrop.append(sel);
                for (let i =0; i<dev.length;i++){
                var option = new Option(dev[i],i,false,false);
                newDrop.append(option);
                }
        newDrop.id = "Drop" + numCanvas;
        newCan.id ="Chart"+numCanvas;
        newCan.height = 300;
        newCan.width = 400;
        var context = newCan.getContext("2d");
        const locale = document.getElementById("cont");
        locale.appendChild(newDrop);
        locale.appendChild(newCan);
        $("#Drop"+numCanvas).data('data',numCanvas)
        name = "Chart"+numCanvas;
        var name = new Chart(context,{
                type:"scatter",
                    data: {
                        labels: "Graph",
                        datasets: [
                         {
                                 label: "Point",
                                 data: {x:0,y:0},
                                 fill: false,
                                 showLine:true,
                                 lineTension: 0.05
                        }
                   ],

                    },
                  options: {
                    responsive: false,
                   scales: {
                     x:{type:'linear',
                         position:'bottom',
                   title:{display:true,text:'Time (hours)'}},
                     }
              
                    }
        });
        chartArray.push(name);
        $(newDrop).change(function (){
            dev = {{Devices | safe}}
            $('#output').val(dev[$(this).find('option:selected').val()]);
            sel=[];
            sel.push(dev[$(this).find('option:selected').val()]);
            sel_data=JSON.stringify(sel);
            num=$(this).data().data;
            $.ajax({
                  url: '/update/'+num,
                  type: 'post',
                  contentType: 'application/json',
                  dataType:'json',
                  data:sel_data,
                  success:function(){update_values([name],num);}
                  });
});
  toSend=[];
  toSend.push(numCanvas);
  toSend=JSON.stringify(toSend);
  $.ajax({
        url: '/add',
        type: 'post',
        contentType: 'application/json',
        dataType:'json',
        data:toSend
  });
  numCanvas++;
  //update_values([name],0);
}



update_values(charts);
var intervalID = setInterval(function(){
        for (let i=0;i<charts.length;i++){
                update_values([charts[i]],i)}
        },10000);
function update_values(numGraphs,j){
   for (let i=0;i<numGraphs.length;i++){
    $.getJSON('/update/'+j,
    function(dataNew) {
         $('#Time').text(dataNew.Time);
         $('#Values').text(dataNew.Values);
         $('#Title').text(dataNew.Title);
         $('#Parsed').text(dataNew.Parsed);
         console.log(dataNew)
    numGraphs[0].data.datasets[0].data=dataNew.Parsed;
    numGraphs[0].data.datasets[0].label=dataNew.Title;
  if($('#Drop'+j).val()!=""){
    numGraphs[0].update();}
         });
 }
       }


</script>
{% endblock %}
