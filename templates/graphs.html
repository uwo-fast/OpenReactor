 {% extends 'layout.html' %}

{% block body %}

<button class="btn btn-primary btn-lg" type="button" onclick="newCanvas(charts)">New Graph</button>
<input type="text" id="output" hidden/>
<br>
<script>
  charts=[];
  numCanvas=0;
  function newCanvas(chartArray){
        var newDiv = document.createElement('div');
        var newDrop = document.createElement('select');
        var newCan = document.createElement('canvas');
        var newBut = document.createElement('button');
        newBut.className = "btn btn-danger";
        newBut.innerHTML="X"
        newDrop.className ="form-select form-select-lg mb-3";
                dev = {{Devices | safe}}
                var sel = new Option("Sensor","",false,false);
                newDrop.append(sel);
                for (let i =0; i<dev.length;i++){
                var option = new Option(dev[i],i,false,false);
                newDrop.append(option);
                }
        newDrop.id = "Drop" + numCanvas;
        newCan.id ="Chart"+numCanvas;
        newDiv.id ="Div"+numCanvas;
        newBut.id = "But"+numCanvas;
        var context = newCan.getContext("2d");
        document.getElementById("cont").appendChild(newDiv);
        const locale = document.getElementById("Div"+numCanvas);
        locale.appendChild(newDrop);
        locale.appendChild(newBut);
        locale.appendChild(newCan);
        $("#Div"+numCanvas).css({width:"500",height:"400px",display:"flex",float:"left"});
        $("#Drop"+numCanvas).css({width:"300px",float:"left",height:"40px"});
        $("#But"+numCanvas).css({width:"40px",height:"40px"});
        newDiv.style.flexWrap="wrap";
        newCan.style.width="400px";
        newCan.style.marginLeft="50px";
        newCan.style.height="300px"
        newDrop.style.marginLeft="50px";
        $("#Drop"+numCanvas).data('data',numCanvas);
        $("#But"+numCanvas).data('data',numCanvas);
        newBut.onclick=function(){
                console.log("id:"+$(this).data().data)
                document.getElementById("Drop"+$(this).data().data).selectedIndex=0;
                document.getElementById("Drop"+$(this).data().data).dispatchEvent(new Event('change'));
                document.getElementById("Div"+$(this).data().data).remove();

        };
        name = "Chart"+numCanvas;
        var name = new Chart(context,{
                type:"scatter",
                    data: {
                        labels: "Graph",
                        datasets: [
                         {
                                 label: "",
                                 data: {x:0,y:0},
                                 fill: false,
                                 showLine:true,
                                 lineTension: 0.05
                        }
                   ],

                    },
                  options: {
                    responsive: false,
                   scales: {
                     x:{type:'linear',
                         position:'bottom',
                   title:{display:true,text:'Time (hours)'}},
                     }
              
                    }
        });
        chartArray.push(name);
        $(newDrop).change(function (){
            dev = {{Devices | safe}}
            sel=[];
            sel.push(dev[$(this).find('option:selected').val()]);
            if(sel[0]==undefined){sel[0]="-1"};
            console.log(sel)
            sel_data=JSON.stringify(sel);
            num=$(this).data().data;
            $.ajax({
                  url: '/update/graphs/'+num,
                  type: 'post',
                  contentType: 'application/json',
                  dataType:'json',
                  data:sel_data,
                  success:function(){update_values([name],num);}
                  });
});
  toSend=[];
  toSend.push(numCanvas);
  toSend=JSON.stringify(toSend);
  $.ajax({
        url: '/add',
        type: 'post',
        contentType: 'application/json',
        dataType:'json',
        data:toSend
  });
  numCanvas++;
  //update_values([name],0);
}

update_values(charts);
var intervalID = setInterval(function(){
        for (let i=0;i<charts.length;i++){
                update_values([charts[i]],i)}
        },10000);
function update_values(numGraphs,j){
   for (let i=0;i<numGraphs.length;i++){
    $.getJSON('/update/graphs/'+j,
    function(dataNew) {
         $('#Time').text(dataNew.Time);
         $('#Values').text(dataNew.Values);
         $('#Title').text(dataNew.Title);
         $('#Parsed').text(dataNew.Parsed);
         console.log(dataNew)
    numGraphs[0].data.datasets[0].data=dataNew.Parsed;
    numGraphs[0].data.datasets[0].label=dataNew.Title;
    numGraphs[0].update();
         });
 }
       }


</script>
{% endblock %}
